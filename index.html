<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ 1‚Äì7 –∫–ª–∞—Å—Å—ã (–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f8;margin:0;padding:10px}
main{max-width:700px;margin:20px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
h2{color:#2c3e50;margin-top:0}
label{display:block;margin-top:15px;font-weight:bold;color:#34495e}
select,button,input{width:100%;padding:12px;margin:8px 0;font-size:16px;border-radius:6px;box-sizing:border-box}
select{border:2px solid #bdc3c7;background:#fff}
button{background:#3498db;color:#fff;border:none;cursor:pointer;font-weight:bold}
button:hover{background:#2980b9}
button:active{transform:scale(0.98)}
input{border:2px solid #bdc3c7}
input:focus{outline:none;border-color:#3498db}
.task{font-size:28px;text-align:center;margin:30px 0;padding:20px;background:#ecf0f1;border-radius:8px;min-height:60px;display:flex;align-items:center;justify-content:center}
.ok{color:#27ae60;font-weight:bold}.bad{color:#e74c3c;font-weight:bold}
.progress{text-align:center;margin:15px 0;color:#7f8c8d;font-size:14px}
.info{background:#e8f5e9;padding:10px;border-radius:6px;margin:10px 0;font-size:14px;color:#2e7d32}
.stats{background:#fff3cd;padding:15px;border-radius:8px;margin:15px 0;border:2px solid #ffc107}
.stats h3{margin:0 0 10px 0;color:#856404}
.stat-row{display:flex;justify-content:space-between;margin:5px 0;font-size:16px}
.stat-label{font-weight:bold;color:#856404}
.stat-value{color:#d68910;font-weight:bold}
.badge{display:inline-block;padding:5px 10px;border-radius:15px;font-size:12px;font-weight:bold;margin:5px 5px 5px 0}
.badge-gold{background:#ffd700;color:#856404}
.badge-silver{background:#c0c0c0;color:#555}
.badge-bronze{background:#cd7f32;color:#fff}
</style>
</head>

<body>
<main>

<h2>üìò –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ 1‚Äì7 –∫–ª–∞—Å—Å—ã (–†–ö)</h2>

<label>–Ø–∑—ã–∫ / –¢—ñ–ª</label>
<select id="lang">
<option value="ru">–†—É—Å—Å–∫–∏–π</option>
<option value="kk">“ö–∞–∑–∞“õ—à–∞</option>
</select>

<label id="gradeLabel">–ö–ª–∞—Å—Å</label>
<select id="grade"></select>

<label id="topicLabel">–¢–µ–º–∞</label>
<select id="topic"></select>

<button id="startBtn" onclick="startLesson()">–ù–∞—á–∞—Ç—å</button>

<div class="stats" id="statsBlock" style="display:none">
<h3 id="statsTitle">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
<div class="stat-row">
<span class="stat-label" id="totalLabel">–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤:</span>
<span class="stat-value" id="totalPoints">0</span>
</div>
<div class="stat-row">
<span class="stat-label" id="correctLabel">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
<span class="stat-value" id="correctCount">0</span>
</div>
<div class="stat-row">
<span class="stat-label" id="accuracyLabel">–¢–æ—á–Ω–æ—Å—Ç—å:</span>
<span class="stat-value" id="accuracy">0%</span>
</div>
<div id="badges"></div>
</div>

<div id="lesson" style="display:none">
<div class="progress" id="progress"></div>
<div class="task" id="task"></div>
<input id="answer" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç" step="any">
<button onclick="check()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
<div id="result" style="text-align:center;margin:15px 0;font-size:18px"></div>
</div>

<div class="info">
‚úì –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —É—á–µ–±–Ω–∏–∫–∞–º –†–ö<br>
‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á<br>
‚úì 10 –∑–∞–¥–∞—á –Ω–∞ –∫–∞–∂–¥—É—é —Ç–µ–º—É
</div>

</main>

<script>
/* ================== –î–ê–ù–ù–´–ï ================== */
let currentLanguage = 'ru'
let currentGrade = 1
let currentTopicIndex = 0
let currentTask = null
let taskIndex = 0

// –¢–ï–ú–´ –ü–û –ö–õ–ê–°–°–ê–ú (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã)
const topicsRu = {
  1: [
    '–ß–∏—Å–ª–∞ –æ—Ç 1 –¥–æ 10',
    '–°–ª–æ–∂–µ–Ω–∏–µ –¥–æ 10',
    '–í—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 10',
    '–ß–∏—Å–ª–∞ –æ—Ç 11 –¥–æ 20',
    '–°–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 20'
  ],
  2: [
    '–°–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 100',
    '–£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ 2 –∏ 3',
    '–£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ 4 –∏ 5',
    '–î–µ–ª–µ–Ω–∏–µ –Ω–∞ 2 –∏ 3',
    '–î–µ–ª–µ–Ω–∏–µ –Ω–∞ 4 –∏ 5'
  ],
  3: [
    '–£–º–Ω–æ–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–µ–Ω–∏–µ –¥–æ 100',
    '–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ 6-7',
    '–¢–∞–±–ª–∏—Ü–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ 8-9',
    '–í–Ω–µ—Ç–∞–±–ª–∏—á–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ',
    '–ó–∞–¥–∞—á–∏ –Ω–∞ –¥–æ–ª–∏'
  ],
  4: [
    '–ú–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã–µ —á–∏—Å–ª–∞',
    '–£–º–Ω–æ–∂–µ–Ω–∏–µ –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã—Ö',
    '–î–µ–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã—Ö',
    '–î—Ä–æ–±–∏ –∏ –¥–æ–ª–∏',
    '–ü–ª–æ—â–∞–¥—å –∏ –ø–µ—Ä–∏–º–µ—Ç—Ä'
  ],
  5: [
    '–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞',
    '–û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥—Ä–æ–±–∏',
    '–î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏',
    '–ü—Ä–æ—Ü–µ–Ω—Ç—ã',
    '–£—Ä–∞–≤–Ω–µ–Ω–∏—è'
  ],
  6: [
    '–û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏',
    '–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞',
    '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å',
    '–õ–∏–Ω–µ–π–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è',
    '–ü—Ä–æ—Ü–µ–Ω—Ç—ã –∏ –∑–∞–¥–∞—á–∏'
  ],
  7: [
    '–°—Ç–µ–ø–µ–Ω–∏ –∏ –∫–æ—Ä–Ω–∏',
    '–õ–∏–Ω–µ–π–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è',
    '–ú–Ω–æ–≥–æ—á–ª–µ–Ω—ã',
    '–°–∏—Å—Ç–µ–º—ã —É—Ä–∞–≤–Ω–µ–Ω–∏–π',
    '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
  ]
}

const topicsKk = {
  1: [
    '1-–¥–µ–Ω 10-“ì–∞ –¥–µ–π—ñ–Ω–≥—ñ —Å–∞–Ω–¥–∞—Ä',
    '10-“ì–∞ –¥–µ–π—ñ–Ω “õ–æ—Å—É',
    '10-“ì–∞ –¥–µ–π—ñ–Ω –∞–∑–∞–π—Ç—É',
    '11-–¥–µ–Ω 20-“ì–∞ –¥–µ–π—ñ–Ω–≥—ñ —Å–∞–Ω–¥–∞—Ä',
    '20-“ì–∞ –¥–µ–π—ñ–Ω “õ–æ—Å—É –∂”ô–Ω–µ –∞–∑–∞–π—Ç—É'
  ],
  2: [
    '100-–≥–µ –¥–µ–π—ñ–Ω “õ–æ—Å—É –∂”ô–Ω–µ –∞–∑–∞–π—Ç—É',
    '2 –∂”ô–Ω–µ 3-–∫–µ –∫”©–±–µ–π—Ç—É',
    '4 –∂”ô–Ω–µ 5-–∫–µ –∫”©–±–µ–π—Ç—É',
    '2 –∂”ô–Ω–µ 3-–∫–µ –±”©–ª—É',
    '4 –∂”ô–Ω–µ 5-–∫–µ –±”©–ª—É'
  ],
  3: [
    '100-–≥–µ –¥–µ–π—ñ–Ω –∫”©–±–µ–π—Ç—É –∂”ô–Ω–µ –±”©–ª—É',
    '6-7-–≥–µ –∫”©–±–µ–π—Ç—É –∫–µ—Å—Ç–µ—Å—ñ',
    '8-9-“ì–∞ –∫”©–±–µ–π—Ç—É –∫–µ—Å—Ç–µ—Å—ñ',
    '–ö–µ—Å—Ç–µ–¥–µ–Ω —Ç—ã—Å –∫”©–±–µ–π—Ç—É',
    '“Æ–ª–µ—Å—Ç–µ—Ä –µ—Å–µ–ø—Ç–µ—Ä—ñ'
  ],
  4: [
    '–ö”©–ø —Ç–∞“£–±–∞–ª—ã —Å–∞–Ω–¥–∞—Ä',
    '–ö”©–ø —Ç–∞“£–±–∞–ª—ã–ª–∞—Ä–¥—ã –∫”©–±–µ–π—Ç—É',
    '–ö”©–ø —Ç–∞“£–±–∞–ª—ã–ª–∞—Ä–¥—ã –±”©–ª—É',
    '–ë”©–ª—à–µ–∫—Ç–µ—Ä –∂”ô–Ω–µ “Ø–ª–µ—Å—Ç–µ—Ä',
    '–ê—É–¥–∞–Ω –∂”ô–Ω–µ –ø–µ—Ä–∏–º–µ—Ç—Ä'
  ],
  5: [
    '–ù–∞—Ç—É—Ä–∞–ª —Å–∞–Ω–¥–∞—Ä',
    '–ñ–∞–π –±”©–ª—à–µ–∫—Ç–µ—Ä',
    '–û–Ω–¥—ã“õ –±”©–ª—à–µ–∫—Ç–µ—Ä',
    '–ü–∞–π—ã–∑–¥–∞—Ä',
    '–¢–µ“£–¥–µ—É–ª–µ—Ä'
  ],
  6: [
    '“ö–∞—Ç—ã–Ω–∞—Å—Ç–∞—Ä –∂”ô–Ω–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏—è–ª–∞—Ä',
    '–†–∞—Ü–∏–æ–Ω–∞–ª —Å–∞–Ω–¥–∞—Ä',
    '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–ª—ã“õ –∂–∞–∑—ã“õ—Ç—ã“õ',
    '–°—ã–∑—ã“õ—Ç—ã“õ —Ç–µ“£–¥–µ—É–ª–µ—Ä',
    '–ü–∞–π—ã–∑–¥–∞—Ä –∂”ô–Ω–µ –µ—Å–µ–ø—Ç–µ—Ä'
  ],
  7: [
    '–î”ô—Ä–µ–∂–µ–ª–µ—Ä –∂”ô–Ω–µ —Ç“Ø–±—ñ—Ä–ª–µ—Ä',
    '–°—ã–∑—ã“õ—Ç—ã“õ —Ç–µ“£–¥–µ—É–ª–µ—Ä',
    '–ö”©–ø–º“Ø—à–µ–ª–µ—Ä',
    '–¢–µ“£–¥–µ—É–ª–µ—Ä –∂“Ø–π–µ—Å—ñ',
    '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
  ]
}

function getTopics() {
  return currentLanguage === 'ru' ? topicsRu : topicsKk
}

/* ================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–î–ê–ß ================== */
const TASKS_PER_TOPIC = 10

function rng(seed) {
  return () => {
    seed = (seed * 9301 + 49297) % 233280
    return seed / 233280
  }
}

// –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞—á –ø–æ –∫–ª–∞—Å—Å—É –∏ —Ç–µ–º–µ
function generateTask(grade, topicIdx, r) {
  const difficulty = topicIdx + 1
  
  // 1 –ö–õ–ê–°–°
  if (grade === 1) {
    if (topicIdx === 0) { // –ß–∏—Å–ª–∞ 1-10
      const a = 1 + Math.floor(r() * 10)
      const b = 1 + Math.floor(r() * 10)
      return { q: `${a} + ${b}`, a: a + b }
    }
    if (topicIdx === 1) { // –°–ª–æ–∂–µ–Ω–∏–µ –¥–æ 10
      const a = 1 + Math.floor(r() * 5)
      const b = 1 + Math.floor(r() * (10 - a))
      return { q: `${a} + ${b}`, a: a + b }
    }
    if (topicIdx === 2) { // –í—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 10
      const a = 5 + Math.floor(r() * 6)
      const b = 1 + Math.floor(r() * (a - 1))
      return { q: `${a} ‚àí ${b}`, a: a - b }
    }
    if (topicIdx === 3) { // –ß–∏—Å–ª–∞ 11-20
      const a = 10 + Math.floor(r() * 10)
      const b = 1 + Math.floor(r() * 5)
      return { q: `${a} + ${b}`, a: a + b }
    }
    if (topicIdx === 4) { // –°–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 20
      const op = r() > 0.5
      if (op) {
        const a = 5 + Math.floor(r() * 10)
        const b = 1 + Math.floor(r() * (20 - a))
        return { q: `${a} + ${b}`, a: a + b }
      } else {
        const a = 10 + Math.floor(r() * 10)
        const b = 1 + Math.floor(r() * (a - 5))
        return { q: `${a} ‚àí ${b}`, a: a - b }
      }
    }
  }
  
  // 2 –ö–õ–ê–°–°
  if (grade === 2) {
    if (topicIdx === 0) { // –°–ª–æ–∂–µ–Ω–∏–µ/–≤—ã—á–∏—Ç–∞–Ω–∏–µ –¥–æ 100
      const op = r() > 0.5
      if (op) {
        const a = 10 + Math.floor(r() * 40)
        const b = 10 + Math.floor(r() * 30)
        return { q: `${a} + ${b}`, a: a + b }
      } else {
        const a = 30 + Math.floor(r() * 50)
        const b = 10 + Math.floor(r() * 30)
        return { q: `${a} ‚àí ${b}`, a: a - b }
      }
    }
    if (topicIdx === 1) { // –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ 2,3
      const m = r() > 0.5 ? 2 : 3
      const n = 2 + Math.floor(r() * 7)
      return { q: `${m} √ó ${n}`, a: m * n }
    }
    if (topicIdx === 2) { // –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ 4,5
      const m = r() > 0.5 ? 4 : 5
      const n = 2 + Math.floor(r() * 7)
      return { q: `${m} √ó ${n}`, a: m * n }
    }
    if (topicIdx === 3) { // –î–µ–ª–µ–Ω–∏–µ –Ω–∞ 2,3
      const d = r() > 0.5 ? 2 : 3
      const q = 2 + Math.floor(r() * 7)
      return { q: `${d * q} √∑ ${d}`, a: q }
    }
    if (topicIdx === 4) { // –î–µ–ª–µ–Ω–∏–µ –Ω–∞ 4,5
      const d = r() > 0.5 ? 4 : 5
      const q = 2 + Math.floor(r() * 7)
      return { q: `${d * q} √∑ ${d}`, a: q }
    }
  }
  
  // 3 –ö–õ–ê–°–°
  if (grade === 3) {
    if (topicIdx === 0) { // –£–º–Ω–æ–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–µ–Ω–∏–µ –¥–æ 100
      const op = r() > 0.5
      if (op) {
        const a = 2 + Math.floor(r() * 8)
        const b = 2 + Math.floor(r() * 8)
        return { q: `${a} √ó ${b}`, a: a * b }
      } else {
        const d = 2 + Math.floor(r() * 7)
        const q = 2 + Math.floor(r() * 8)
        return { q: `${d * q} √∑ ${d}`, a: q }
      }
    }
    if (topicIdx === 1) { // –¢–∞–±–ª–∏—Ü–∞ 6-7
      const m = r() > 0.5 ? 6 : 7
      const n = 2 + Math.floor(r() * 8)
      return { q: `${m} √ó ${n}`, a: m * n }
    }
    if (topicIdx === 2) { // –¢–∞–±–ª–∏—Ü–∞ 8-9
      const m = r() > 0.5 ? 8 : 9
      const n = 2 + Math.floor(r() * 8)
      return { q: `${m} √ó ${n}`, a: m * n }
    }
    if (topicIdx === 3) { // –í–Ω–µ—Ç–∞–±–ª–∏—á–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ
      const a = 10 + Math.floor(r() * 10)
      const b = 2 + Math.floor(r() * 5)
      return { q: `${a} √ó ${b}`, a: a * b }
    }
    if (topicIdx === 4) { // –ó–∞–¥–∞—á–∏ –Ω–∞ –¥–æ–ª–∏
      const whole = [20, 30, 40, 60, 80, 100][Math.floor(r() * 6)]
      const frac = [2, 4, 5][Math.floor(r() * 3)]
      const txt = currentLanguage === 'ru' ? `1/${frac} –æ—Ç ${whole}` : `${whole}-–¥—ñ“£ 1/${frac}`
      return { q: txt, a: whole / frac }
    }
  }
  
  // 4 –ö–õ–ê–°–°
  if (grade === 4) {
    if (topicIdx === 0) { // –ú–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã–µ —á–∏—Å–ª–∞
      const a = 100 + Math.floor(r() * 900)
      const b = 50 + Math.floor(r() * 200)
      return { q: `${a} + ${b}`, a: a + b }
    }
    if (topicIdx === 1) { // –£–º–Ω–æ–∂–µ–Ω–∏–µ –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã—Ö
      const a = 10 + Math.floor(r() * 90)
      const b = 10 + Math.floor(r() * 20)
      return { q: `${a} √ó ${b}`, a: a * b }
    }
    if (topicIdx === 2) { // –î–µ–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω—ã—Ö
      const d = 10 + Math.floor(r() * 15)
      const q = 5 + Math.floor(r() * 20)
      return { q: `${d * q} √∑ ${d}`, a: q }
    }
    if (topicIdx === 3) { // –î—Ä–æ–±–∏
      const nums = [[1,2],[1,3],[1,4],[2,3],[3,4],[1,5]]
      const [n, d] = nums[Math.floor(r() * nums.length)]
      const w = 10 + Math.floor(r() * 40)
      const txt = currentLanguage === 'ru' ? `${n}/${d} –æ—Ç ${w}` : `${w}-–¥—ñ“£ ${n}/${d}`
      return { q: txt, a: Math.round(w * n / d) }
    }
    if (topicIdx === 4) { // –ü–µ—Ä–∏–º–µ—Ç—Ä
      const a = 5 + Math.floor(r() * 15)
      const b = 5 + Math.floor(r() * 15)
      const txt = currentLanguage === 'ru' ? `P ‚ñ° a=${a}, b=${b}` : `P ‚ñ° a=${a}, b=${b}`
      return { q: txt, a: 2 * (a + b) }
    }
  }
  
  // 5 –ö–õ–ê–°–°
  if (grade === 5) {
    if (topicIdx === 0) { // –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
      const a = 100 + Math.floor(r() * 900)
      const b = 100 + Math.floor(r() * 500)
      return { q: `${a} + ${b}`, a: a + b }
    }
    if (topicIdx === 1) { // –û–±—ã–∫–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥—Ä–æ–±–∏
      const pairs = [[1,2,1,4],[1,3,1,6],[2,3,1,3],[3,4,1,4]]
      const [n1,d1,n2,d2] = pairs[Math.floor(r() * pairs.length)]
      const txt = currentLanguage === 'ru' ? `${n1}/${d1} + ${n2}/${d2}` : `${n1}/${d1} + ${n2}/${d2}`
      const a = n1/d1 + n2/d2
      return { q: txt, a: Math.round(a * 100) / 100 }
    }
    if (topicIdx === 2) { // –î–µ—Å—è—Ç–∏—á–Ω—ã–µ –¥—Ä–æ–±–∏
      const a = (5 + r() * 20).toFixed(1)
      const b = (2 + r() * 10).toFixed(1)
      return { q: `${a} + ${b}`, a: parseFloat(a) + parseFloat(b) }
    }
    if (topicIdx === 3) { // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
      const base = [100, 200, 50, 150][Math.floor(r() * 4)]
      const p = [10, 20, 25, 50][Math.floor(r() * 4)]
      const txt = currentLanguage === 'ru' ? `${p}% –æ—Ç ${base}` : `${base}-–¥—ñ“£ ${p}%`
      return { q: txt, a: base * p / 100 }
    }
    if (topicIdx === 4) { // –£—Ä–∞–≤–Ω–µ–Ω–∏—è
      const x = 5 + Math.floor(r() * 30)
      const c = 10 + Math.floor(r() * 20)
      return { q: `x + ${c} = ${x + c}`, a: x }
    }
  }
  
  // 6 –ö–õ–ê–°–°
  if (grade === 6) {
    if (topicIdx === 0) { // –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏
      const a = 2 + Math.floor(r() * 8)
      const k = 2 + Math.floor(r() * 5)
      const txt = currentLanguage === 'ru' ? `${a}:${k} = x:${k*2}` : `${a}:${k} = x:${k*2}`
      return { q: txt, a: a * 2 }
    }
    if (topicIdx === 1) { // –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
      const a = -10 + Math.floor(r() * 20)
      const b = -5 + Math.floor(r() * 15)
      return { q: `${a} + (${b})`, a: a + b }
    }
    if (topicIdx === 2) { // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
      const x = -5 + Math.floor(r() * 10)
      const txt = currentLanguage === 'ru' ? `A(${x}, ?) –Ω–∞ y=2x` : `A(${x}, ?) y=2x-—Ç–µ`
      return { q: txt, a: 2 * x }
    }
    if (topicIdx === 3) { // –õ–∏–Ω–µ–π–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
      const x = 5 + Math.floor(r() * 20)
      const k = 2 + Math.floor(r() * 5)
      const c = 10 + Math.floor(r() * 15)
      return { q: `${k}x + ${c} = ${k*x + c}`, a: x }
    }
    if (topicIdx === 4) { // –ü—Ä–æ—Ü–µ–Ω—Ç—ã
      const base = [200, 300, 400, 500][Math.floor(r() * 4)]
      const p = [15, 30, 40][Math.floor(r() * 3)]
      const txt = currentLanguage === 'ru' ? `${p}% –æ—Ç ${base}` : `${base}-–¥—ñ“£ ${p}%`
      return { q: txt, a: base * p / 100 }
    }
  }
  
  // 7 –ö–õ–ê–°–°
  if (grade === 7) {
    if (topicIdx === 0) { // –°—Ç–µ–ø–µ–Ω–∏
      const base = 2 + Math.floor(r() * 4)
      const pow = 2 + Math.floor(r() * 3)
      return { q: `${base}^${pow}`, a: Math.pow(base, pow) }
    }
    if (topicIdx === 1) { // –õ–∏–Ω–µ–π–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
      const x = 3 + Math.floor(r() * 15)
      const k = 3 + Math.floor(r() * 6)
      const c = 5 + Math.floor(r() * 20)
      return { q: `${k}x ‚àí ${c} = ${k*x - c}`, a: x }
    }
    if (topicIdx === 2) { // –ú–Ω–æ–≥–æ—á–ª–µ–Ω—ã
      const a = 2 + Math.floor(r() * 5)
      const b = 3 + Math.floor(r() * 5)
      const x = 2
      return { q: `(${a}x+${b}) –ø—Ä–∏ x=2`, a: a * x + b }
    }
    if (topicIdx === 3) { // –°–∏—Å—Ç–µ–º—ã —É—Ä–∞–≤–Ω–µ–Ω–∏–π
      const x = 2 + Math.floor(r() * 8)
      const y = 3 + Math.floor(r() * 7)
      return { q: `x+y=${x+y}, x‚àíy=${x-y}. x=?`, a: x }
    }
    if (topicIdx === 4) { // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      const nums = [10,12,15,18,20].map(n => n + Math.floor(r() * 5))
      const avg = nums.reduce((s,n) => s + n, 0) / nums.length
      const txt = currentLanguage === 'ru' ? `–°—Ä–µ–¥–Ω–µ–µ: ${nums.join(',')}` : `–û—Ä—Ç–∞—à–∞: ${nums.join(',')}`
      return { q: txt, a: Math.round(avg) }
    }
  }
  
  // Fallback
  return { q: '2 + 2', a: 4 }
}

/* ================== –ë–ê–ù–ö –ó–ê–î–ê–ß ================== */
const taskBank = {}

function buildTaskBank() {
  for (let g = 1; g <= 7; g++) {
    taskBank[g] = {}
    const topics = getTopics()[g]
    topics.forEach((_, topicIdx) => {
      const r = rng(g * 1000 + topicIdx * 100 + Date.now() % 1000)
      taskBank[g][topicIdx] = []
      for (let i = 0; i < TASKS_PER_TOPIC; i++) {
        taskBank[g][topicIdx].push(generateTask(g, topicIdx, r))
      }
    })
  }
}

/* ================== –ü–†–û–ì–†–ï–°–° ================== */
const store = (k, v) => v === undefined ? JSON.parse(localStorage.getItem(k) || '{}') : localStorage.setItem(k, JSON.stringify(v))

function getProgress(g, t) {
  const data = store('progress')
  return data[`${g}_${t}`] || { index: 0, correct: 0 }
}

function saveProgress(g, t, p) {
  const data = store('progress')
  data[`${g}_${t}`] = p
  store('progress', data)
}

function getStats() {
  return store('stats') || { totalPoints: 0, totalCorrect: 0, totalAttempts: 0 }
}

function saveStats(stats) {
  store('stats', stats)
}

function addPoints(points) {
  const stats = getStats()
  stats.totalPoints += points
  stats.totalCorrect++
  stats.totalAttempts++
  saveStats(stats)
  updateStatsDisplay()
}

function addAttempt() {
  const stats = getStats()
  stats.totalAttempts++
  saveStats(stats)
  updateStatsDisplay()
}

function updateStatsDisplay() {
  const stats = getStats()
  document.getElementById('totalPoints').textContent = stats.totalPoints
  document.getElementById('correctCount').textContent = stats.totalCorrect
  
  const accuracy = stats.totalAttempts > 0 
    ? Math.round((stats.totalCorrect / stats.totalAttempts) * 100) 
    : 0
  document.getElementById('accuracy').textContent = accuracy + '%'
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–∫–∏
  updateBadges(stats.totalPoints)
}

/* ================== UI ================== */
function fillGrades() {
  const sel = document.getElementById('grade')
  sel.innerHTML = ''
  for (let i = 1; i <= 7; i++) {
    sel.innerHTML += `<option value="${i}">${i} ${currentLanguage === 'ru' ? '–∫–ª–∞—Å—Å' : '—Å—ã–Ω—ã–ø'}</option>`
  }
  sel.value = currentGrade
  sel.onchange = () => {
    currentGrade = +sel.value
    fillTopics()
  }
}

function fillTopics() {
  const sel = document.getElementById('topic')
  const topics = getTopics()[currentGrade]
  sel.innerHTML = ''
  topics.forEach((topic, i) => {
    sel.innerHTML += `<option value="${i}">${topic}</option>`
  })
  sel.value = currentTopicIndex
  sel.onchange = () => {
    currentTopicIndex = +sel.value
  }
  currentTopicIndex = 0
}

function updateLabels() {
  document.getElementById('gradeLabel').textContent = currentLanguage === 'ru' ? '–ö–ª–∞—Å—Å' : '–°—ã–Ω—ã–ø'
  document.getElementById('topicLabel').textContent = currentLanguage === 'ru' ? '–¢–µ–º–∞' : '–¢–∞“õ—ã—Ä—ã–ø'
  document.getElementById('startBtn').textContent = currentLanguage === 'ru' ? '–ù–∞—á–∞—Ç—å' : '–ë–∞—Å—Ç–∞—É'
  document.getElementById('answer').placeholder = currentLanguage === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç' : '–ñ–∞—É–∞–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑'
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  document.getElementById('statsTitle').textContent = currentLanguage === 'ru' ? 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' : 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'
  document.getElementById('totalLabel').textContent = currentLanguage === 'ru' ? '–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤:' : '–ë–∞—Ä–ª—ã“õ “±–ø–∞–π:'
  document.getElementById('correctLabel').textContent = currentLanguage === 'ru' ? '–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:' : '–î“±—Ä—ã—Å –∂–∞—É–∞–ø—Ç–∞—Ä:'
  document.getElementById('accuracyLabel').textContent = currentLanguage === 'ru' ? '–¢–æ—á–Ω–æ—Å—Ç—å:' : '–î”ô–ª–¥—ñ–∫:'
}

function updateBadges(points) {
  const badgesDiv = document.getElementById('badges')
  let badgesHtml = ''
  
  const badges = [
    { points: 10, name: currentLanguage === 'ru' ? '–ù–æ–≤–∏—á–æ–∫' : '–ñ–∞“£–∞–¥–∞–Ω –±–∞—Å—Ç–∞“ì–∞–Ω', class: 'badge-bronze' },
    { points: 50, name: currentLanguage === 'ru' ? '–ó–Ω–∞—Ç–æ–∫' : '–ë—ñ–ª–≥—ñ—à', class: 'badge-silver' },
    { points: 100, name: currentLanguage === 'ru' ? '–ú–∞—Å—Ç–µ—Ä' : '–®–µ–±–µ—Ä', class: 'badge-silver' },
    { points: 200, name: currentLanguage === 'ru' ? '–≠–∫—Å–ø–µ—Ä—Ç' : '–°–∞—Ä–∞–ø—à—ã', class: 'badge-gold' },
    { points: 500, name: currentLanguage === 'ru' ? '–ß–µ–º–ø–∏–æ–Ω' : '–ß–µ–º–ø–∏–æ–Ω', class: 'badge-gold' }
  ]
  
  badges.forEach(badge => {
    if (points >= badge.points) {
      badgesHtml += `<span class="badge ${badge.class}">${badge.name}</span>`
    }
  })
  
  badgesDiv.innerHTML = badgesHtml
}

function startLesson() {
  buildTaskBank()
  document.getElementById('lesson').style.display = 'block'
  document.getElementById('statsBlock').style.display = 'block'
  taskIndex = 0
  updateStatsDisplay()
  nextTask()
}

function nextTask() {
  const prog = getProgress(currentGrade, currentTopicIndex)
  taskIndex = prog.index
  
  if (taskIndex >= TASKS_PER_TOPIC) {
    taskIndex = 0
    prog.index = 0
    prog.correct = 0
    saveProgress(currentGrade, currentTopicIndex, prog)
  }
  
  currentTask = taskBank[currentGrade][currentTopicIndex][taskIndex]
  document.getElementById('task').textContent = currentTask.q
  document.getElementById('answer').value = ''
  document.getElementById('result').innerHTML = ''
  
  const progressText = currentLanguage === 'ru' 
    ? `–ó–∞–¥–∞–Ω–∏–µ ${taskIndex + 1} –∏–∑ ${TASKS_PER_TOPIC}` 
    : `–¢–∞–ø—Å—ã—Ä–º–∞ ${taskIndex + 1} / ${TASKS_PER_TOPIC}`
  document.getElementById('progress').textContent = progressText
  
  document.getElementById('answer').focus()
}

function check() {
  const userAns = parseFloat(document.getElementById('answer').value)
  const correct = Math.abs(userAns - currentTask.a) < 0.01
  
  const result = document.getElementById('result')
  const prog = getProgress(currentGrade, currentTopicIndex)
  
  if (correct) {
    // –ë–∞–ª–ª—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–ª–∞—Å—Å–∞: 1 –∫–ª–∞—Å—Å = 1 –±–∞–ª–ª, 7 –∫–ª–∞—Å—Å = 7 –±–∞–ª–ª–æ–≤
    const points = currentGrade
    addPoints(points)
    
    result.innerHTML = `<span class="ok">${currentLanguage === 'ru' ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ! +' : '‚úì –î“±—Ä—ã—Å! +'} ${points} ${currentLanguage === 'ru' ? '–±–∞–ª–ª' : '“±–ø–∞–π'}</span>`
    prog.correct++
  } else {
    addAttempt()
    result.innerHTML = `<span class="bad">${currentLanguage === 'ru' ? '‚úó –ù–µ–≤–µ—Ä–Ω–æ. –û—Ç–≤–µ—Ç' : '‚úó “ö–∞—Ç–µ. –ñ–∞—É–∞–±—ã'}: ${currentTask.a}</span>`
  }
  
  prog.index = (prog.index + 1) % TASKS_PER_TOPIC
  saveProgress(currentGrade, currentTopicIndex, prog)
  
  setTimeout(nextTask, 1500)
}

// Enter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('answer').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') check()
  })
})

/* ================== INIT ================== */
document.getElementById('lang').onchange = (e) => {
  currentLanguage = e.target.value
  fillGrades()
  fillTopics()
  updateLabels()
}

fillGrades()
fillTopics()
updateLabels()
</script>
</body>
</html>